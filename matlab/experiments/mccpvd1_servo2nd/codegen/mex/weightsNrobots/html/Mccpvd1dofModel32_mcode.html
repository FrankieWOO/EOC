<!-- saved from url=(0014)about:internet -->
<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="20,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">classdef</span> Mccpvd1dofModel</span></span>
<span class="srcline"><span class="lineno"><a href="20,2" id="srcline2">  2</a></span><span class="line">    <span class="comment">%   MACCEPA-VD</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,3" id="srcline3">  3</a></span><span class="line">    <span class="comment">%   Detailed explanation goes here</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,4" id="srcline4">  4</a></span><span class="line">    <span class="comment">%   1DoF MACCEPAVD</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,5" id="srcline5">  5</a></span><span class="line">    <span class="comment">%   x: q ; dq ; theta1 ; theta2; dtheta1; dtheta2;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,6" id="srcline6">  6</a></span><span class="line">    <span class="comment">%   </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,7" id="srcline7">  7</a></span><span class="line">    <span class="comment">%   </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,8" id="srcline8">  8</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="20,9" id="srcline9">  9</a></span><span class="line">    <span class="keyword">properties</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,10" id="srcline10"> 10</a></span><span class="line">        robot_type = <span class="string">'Maccepavd1DOF'</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="20,11" id="srcline11"> 11</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,12" id="srcline12"> 12</a></span><span class="line">        cdt = 0.02 <span class="comment">% controller time step</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,13" id="srcline13"> 13</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,14" id="srcline14"> 14</a></span><span class="line">        dimQ = 1<span class="comment">% dimension of joints</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,15" id="srcline15"> 15</a></span><span class="line">        dimX = 6<span class="comment">% dimension of states</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,16" id="srcline16"> 16</a></span><span class="line">        dimU = 3<span class="comment">% dimension of controls</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,17" id="srcline17"> 17</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,18" id="srcline18"> 18</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,19" id="srcline19"> 19</a></span><span class="line">        <span class="comment">%%%% physical design</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,20" id="srcline20"> 20</a></span><span class="line">        <span class="comment">% physical joint constriants</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,21" id="srcline21"> 21</a></span><span class="line">        <span class="comment">% note that the physical constriant of joint is the rechable point</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,22" id="srcline22"> 22</a></span><span class="line">        <span class="comment">% not the controllable point</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,23" id="srcline23"> 23</a></span><span class="line">        qmax = 135*pi/180; <span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,24" id="srcline24"> 24</a></span><span class="line">        qmin = -135*pi/180; <span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,25" id="srcline25"> 25</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,26" id="srcline26"> 26</a></span><span class="line">        link_length = 0.15;<span class="comment">% link length</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,27" id="srcline27"> 27</a></span><span class="line">        link_mass = 0.09;</span></span>
<span class="srcline"><span class="lineno"><a href="20,28" id="srcline28"> 28</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,29" id="srcline29"> 29</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,30" id="srcline30"> 30</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,31" id="srcline31"> 31</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,32" id="srcline32"> 32</a></span><span class="line">        servo1_mass = 0.09;</span></span>
<span class="srcline"><span class="lineno"><a href="20,33" id="srcline33"> 33</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,34" id="srcline34"> 34</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,35" id="srcline35"> 35</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,36" id="srcline36"> 36</a></span><span class="line">        rege_ratio = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="20,37" id="srcline37"> 37</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,38" id="srcline38"> 38</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,39" id="srcline39"> 39</a></span><span class="line">        <span class="comment">%%%% ---- physical design</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,40" id="srcline40"> 40</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,41" id="srcline41"> 41</a></span><span class="line">        <span class="comment">%%%% servo motor specification, reflected at gearbox output shaft</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,42" id="srcline42"> 42</a></span><span class="line">        inertia_m1 = 0.0099;</span></span>
<span class="srcline"><span class="lineno"><a href="20,43" id="srcline43"> 43</a></span><span class="line">        K_m1 = 0.3811; <span class="comment">% torque constant</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,44" id="srcline44"> 44</a></span><span class="line">        D_m1 = 0.2009;</span></span>
<span class="srcline"><span class="lineno"><a href="20,45" id="srcline45"> 45</a></span><span class="line">        R_m1 = 0.8222;</span></span>
<span class="srcline"><span class="lineno"><a href="20,46" id="srcline46"> 46</a></span><span class="line">        inertia_m2 = 0.0099;</span></span>
<span class="srcline"><span class="lineno"><a href="20,47" id="srcline47"> 47</a></span><span class="line">        K_m2 = 0.3811;</span></span>
<span class="srcline"><span class="lineno"><a href="20,48" id="srcline48"> 48</a></span><span class="line">        D_m2 = 0.2009;</span></span>
<span class="srcline"><span class="lineno"><a href="20,49" id="srcline49"> 49</a></span><span class="line">        R_m2 = 0.8222;</span></span>
<span class="srcline"><span class="lineno"><a href="20,50" id="srcline50"> 50</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,51" id="srcline51"> 51</a></span><span class="line">        alpha_servo = 30; <span class="comment">% Fan: fit from data</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,52" id="srcline52"> 52</a></span><span class="line">        <span class="comment">%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,53" id="srcline53"> 53</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,54" id="srcline54"> 54</a></span><span class="line">        <span class="comment">%%%% dynamical properties</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,55" id="srcline55"> 55</a></span><span class="line">        <span class="comment">% Fan: estimated by data  %calculated inertia: 0.00135</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,56" id="srcline56"> 56</a></span><span class="line">        <span class="comment">% damper motor inertia: </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,57" id="srcline57"> 57</a></span><span class="line">        inertia = 0.0016 </span></span>
<span class="srcline"><span class="lineno"><a href="20,58" id="srcline58"> 58</a></span><span class="line">        <span class="comment">% frictions</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,59" id="srcline59"> 59</a></span><span class="line">        <span class="comment">% viscous friction</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,60" id="srcline60"> 60</a></span><span class="line">        <span class="comment">% Fan: 0.0022 estimated by data;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,61" id="srcline61"> 61</a></span><span class="line">        Df = 0.0022 </span></span>
<span class="srcline"><span class="lineno"><a href="20,62" id="srcline62"> 62</a></span><span class="line">        <span class="comment">% coulomb friction</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,63" id="srcline63"> 63</a></span><span class="line">        coulomb_friction = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="20,64" id="srcline64"> 64</a></span><span class="line">        <span class="comment">% gravity constant</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,65" id="srcline65"> 65</a></span><span class="line">        gravity_constant = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="20,66" id="srcline66"> 66</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,67" id="srcline67"> 67</a></span><span class="line">        <span class="comment">%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,68" id="srcline68"> 68</a></span><span class="line">        <span class="comment">%%%% control input limits</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,69" id="srcline69"> 69</a></span><span class="line">        <span class="comment">% u1 and u2 are defined in rad; round to int and below the physical</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,70" id="srcline70"> 70</a></span><span class="line">        <span class="comment">% limit to protect the servo</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,71" id="srcline71"> 71</a></span><span class="line">        umax = [ 1; 2; 1] ;</span></span>
<span class="srcline"><span class="lineno"><a href="20,72" id="srcline72"> 72</a></span><span class="line">        umin = [-1; 0; 0] ;</span></span>
<span class="srcline"><span class="lineno"><a href="20,73" id="srcline73"> 73</a></span><span class="line">        <span class="comment">%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,74" id="srcline74"> 74</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,75" id="srcline75"> 75</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="20,76" id="srcline76"> 76</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,77" id="srcline77"> 77</a></span><span class="line">        <span class="comment">%%%% function handlers</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,78" id="srcline78"> 78</a></span><span class="line">        fnMotorDyn</span></span>
<span class="srcline"><span class="lineno"><a href="20,79" id="srcline79"> 79</a></span><span class="line">        dynx</span></span>
<span class="srcline"><span class="lineno"><a href="20,80" id="srcline80"> 80</a></span><span class="line">        dynu</span></span>
<span class="srcline"><span class="lineno"><a href="20,81" id="srcline81"> 81</a></span><span class="line">        <span class="comment">%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,82" id="srcline82"> 82</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,83" id="srcline83"> 83</a></span><span class="line">        <span class="comment">%%%% symbolic</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,84" id="srcline84"> 84</a></span><span class="line">        symDyn</span></span>
<span class="srcline"><span class="lineno"><a href="20,85" id="srcline85"> 85</a></span><span class="line">        symDynx</span></span>
<span class="srcline"><span class="lineno"><a href="20,86" id="srcline86"> 86</a></span><span class="line">        symDynu</span></span>
<span class="srcline"><span class="lineno"><a href="20,87" id="srcline87"> 87</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,88" id="srcline88"> 88</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,89" id="srcline89"> 89</a></span><span class="line">        <span class="comment">%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,90" id="srcline90"> 90</a></span><span class="line">        actuator</span></span>
<span class="srcline"><span class="lineno"><a href="20,91" id="srcline91"> 91</a></span><span class="line">        <span class="comment">%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,92" id="srcline92"> 92</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,93" id="srcline93"> 93</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,94" id="srcline94"> 94</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,95" id="srcline95"> 95</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="20,96" id="srcline96"> 96</a></span><span class="line">    <span class="keyword">properties</span> (Access = private)</span></span>
<span class="srcline"><span class="lineno"><a href="20,97" id="srcline97"> 97</a></span><span class="line">        dynxfull</span></span>
<span class="srcline"><span class="lineno"><a href="20,98" id="srcline98"> 98</a></span><span class="line">        dynufull</span></span>
<span class="srcline"><span class="lineno"><a href="20,99" id="srcline99"> 99</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,100" id="srcline100">100</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="20,101" id="srcline101">101</a></span><span class="line">    <span class="keyword">methods</span></span></span>
</pre>
</div>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="20,102" id="srcline102">102</a></span><span class="line">        <span class="mxinfo " id="T35:U1"><span class="keyword">function</span> <span class="var type1" id="S39T35U133">model</span> = Mccpvd1dofModel()</span></span>
<span class="srcline"><span class="lineno"><a href="20,103" id="srcline103">103</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,104" id="srcline104">104</a></span><span class="line">            <span class="comment">% gear ratio from theta1 to q</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,105" id="srcline105">105</a></span><span class="line"><span class="comment">%             gear1 = 3/4; %Nin = 44, Nout = 33; </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,106" id="srcline106">106</a></span><span class="line"><span class="comment">%         </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,107" id="srcline107">107</a></span><span class="line"><span class="comment">%             spring_constant = 231;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,108" id="srcline108">108</a></span><span class="line"><span class="comment">%             lever_length = 0.036; %B</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,109" id="srcline109">109</a></span><span class="line"><span class="comment">%             pin_displacement = 0.135; %C</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,110" id="srcline110">110</a></span><span class="line"><span class="comment">%             </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,111" id="srcline111">111</a></span><span class="line"><span class="comment">%             drum_radius = 0.015;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,112" id="srcline112">112</a></span><span class="line">            <span class="comment">%variable damping range</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,113" id="srcline113">113</a></span><span class="line">            <span class="comment">% 110255 : 0.00848</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,114" id="srcline114">114</a></span><span class="line"><span class="comment">%             damping_range = [0, 0.00848];</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,115" id="srcline115">115</a></span><span class="line">            <span class="mxinfo " id="T36:U3"><span class="mxinfo " id="T36:U4"><span class="var type1" id="S39T35U139">model</span>.actuator</span> = <span class="mxinfo " id="T36:U6"><span class="fcn" id="F33N2:B142">ActMccpvd</span>()</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="20,116" id="srcline116">116</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,117" id="srcline117">117</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,118" id="srcline118">118</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,119" id="srcline119">119</a></span><span class="line">            <span class="comment">%model = model.init_symfuns();</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,120" id="srcline120">120</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="20,121" id="srcline121">121</a></span><span class="line">        <span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="20,122" id="srcline122">122</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,123" id="srcline123">123</a></span><span class="line"><span class="comment">%         function [model] = init_symfuns(model)</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,124" id="srcline124">124</a></span><span class="line"><span class="comment">%             %%%% setup symbolic dynamics and compute jacobian functions</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,125" id="srcline125">125</a></span><span class="line"><span class="comment">%             xv=sym('x',[6 1]);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,126" id="srcline126">126</a></span><span class="line"><span class="comment">%             uv=sym('u',[3 1]);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,127" id="srcline127">127</a></span><span class="line"><span class="comment">%             model.symDyn = symfun(model.dynamics(xv,uv),[xv;uv]);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,128" id="srcline128">128</a></span><span class="line"><span class="comment">%             model.symDynx = jacobian(model.symDyn,xv);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,129" id="srcline129">129</a></span><span class="line"><span class="comment">%             model.symDynu = jacobian(model.symDyn,uv);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,130" id="srcline130">130</a></span><span class="line"><span class="comment">%             model.dynxfull = matlabFunction(model.symDynx);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,131" id="srcline131">131</a></span><span class="line"><span class="comment">%             model.dynufull = matlabFunction(model.symDynu);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,132" id="srcline132">132</a></span><span class="line"><span class="comment">%             model.dynx =@(x,u)model.dynxfull (x(1),x(2),x(3),x(4),x(5),x(6),u(1),u(2),u(3));</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,133" id="srcline133">133</a></span><span class="line"><span class="comment">%             model.dynu =@(x,u)model.dynufull(x(1),x(2),x(3),x(4),x(5),x(6),u(1),u(2),u(3));</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,134" id="srcline134">134</a></span><span class="line"><span class="comment">%             %model.dynx = matlabFunction(model.dynx);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,135" id="srcline135">135</a></span><span class="line"><span class="comment">%             %model.dynu = matlabFunction(model.dynu);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,136" id="srcline136">136</a></span><span class="line"><span class="comment">%             %%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,137" id="srcline137">137</a></span><span class="line"><span class="comment">%             </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,138" id="srcline138">138</a></span><span class="line"><span class="comment">%         end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,139" id="srcline139">139</a></span><span class="line">        </span></span>
</pre>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="20,140" id="srcline140">140</a></span><span class="line">        <span class="comment">% state-space forward dynamics</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,141" id="srcline141">141</a></span><span class="line">        <span class="keyword">function</span> [xdot]= dynamics(model, x, u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,142" id="srcline142">142</a></span><span class="line">            qddot = model.cmptAcc(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,143" id="srcline143">143</a></span><span class="line">            qdot = x(2,:);</span></span>
<span class="srcline"><span class="lineno"><a href="20,144" id="srcline144">144</a></span><span class="line">            xdot1 = [qdot; qddot] ;</span></span>
<span class="srcline"><span class="lineno"><a href="20,145" id="srcline145">145</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="20,146" id="srcline146">146</a></span><span class="line">            <span class="comment">% motor dynamics</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,147" id="srcline147">147</a></span><span class="line">            xdot2 = model.motor_dynamics_2nd(x(3:end),u(1:2));</span></span>
<span class="srcline"><span class="lineno"><a href="20,148" id="srcline148">148</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,149" id="srcline149">149</a></span><span class="line">            xdot  = [xdot1;</span></span>
<span class="srcline"><span class="lineno"><a href="20,150" id="srcline150">150</a></span><span class="line">                    xdot2];</span></span>
<span class="srcline"><span class="lineno"><a href="20,151" id="srcline151">151</a></span><span class="line">            <span class="comment">% current motor positions</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,152" id="srcline152">152</a></span><span class="line">            <span class="comment">%m     = [x(3);x(6)] ; </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,153" id="srcline153">153</a></span><span class="line">            <span class="comment">%if nargout &gt; 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,154" id="srcline154">154</a></span><span class="line">            <span class="comment">% Compute xdot_x, xdot_u using finite differences</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,155" id="srcline155">155</a></span><span class="line">                <span class="comment">%delta = 1e-6;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,156" id="srcline156">156</a></span><span class="line">                <span class="comment">%dimX = size(x,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,157" id="srcline157">157</a></span><span class="line">                <span class="comment">%dimU = size(u,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,158" id="srcline158">158</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="20,159" id="srcline159">159</a></span><span class="line">            <span class="comment">% Compute derivative of acceleration w.r.t. x</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,160" id="srcline160">160</a></span><span class="line"><span class="comment">%                 daccdx = zeros(1,model.dimX);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,161" id="srcline161">161</a></span><span class="line"><span class="comment">%                 f = @(x)get_acceleration_maccepa(x(1:2),[m;u(3)],model);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,162" id="srcline162">162</a></span><span class="line"><span class="comment">%                 daccdx(:,1:2)=get_jacobian_fd(f,x(1:2));</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,163" id="srcline163">163</a></span><span class="line"><span class="comment">%                 f = @(m)get_acceleration_maccepa(x(1:2),[m;u(3)],model);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,164" id="srcline164">164</a></span><span class="line"><span class="comment">%                 daccdx(:,[3;6])=get_jacobian_fd(f,m);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,165" id="srcline165">165</a></span><span class="line"><span class="comment">%     </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,166" id="srcline166">166</a></span><span class="line"><span class="comment">%                 % Compute derivative of acceleration w.r.t. u</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,167" id="srcline167">167</a></span><span class="line"><span class="comment">%                 daccdu = zeros(1,model.dimU);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,168" id="srcline168">168</a></span><span class="line"><span class="comment">%                 f = @(u3)get_acceleration_maccepa(x(1:2),[m;u3],model);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,169" id="srcline169">169</a></span><span class="line"><span class="comment">%                 daccdu(3)=get_jacobian_fd(f,u(3));</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,170" id="srcline170">170</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,171" id="srcline171">171</a></span><span class="line"><span class="comment">%                 xdot_x = [0, 1, zeros(1,6);<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="20,172" id="srcline172">172</a></span><span class="line"><span class="comment">%                             daccdx          ;<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="20,173" id="srcline173">173</a></span><span class="line"><span class="comment">%                             zeros(6,2), xdot_x2];</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,174" id="srcline174">174</a></span><span class="line"><span class="comment">%           </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,175" id="srcline175">175</a></span><span class="line"><span class="comment">%                 xdot_u = [zeros(1,3);<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="20,176" id="srcline176">176</a></span><span class="line"><span class="comment">%                         daccdu; </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,177" id="srcline177">177</a></span><span class="line"><span class="comment">%                         xdot_u2,zeros(6,1)];</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,178" id="srcline178">178</a></span><span class="line"><span class="comment">%             end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,179" id="srcline179">179</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,180" id="srcline180">180</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,181" id="srcline181">181</a></span><span class="line">        <span class="keyword">function</span> [xdot, xdot_x, xdot_u]= dynamics_with_jacobian_fd(model, x, u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,182" id="srcline182">182</a></span><span class="line">            qddot = model.cmptAcc(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,183" id="srcline183">183</a></span><span class="line">            qdot = x(2,:);</span></span>
<span class="srcline"><span class="lineno"><a href="20,184" id="srcline184">184</a></span><span class="line">            xdot1 = [qdot; qddot] ;</span></span>
<span class="srcline"><span class="lineno"><a href="20,185" id="srcline185">185</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="20,186" id="srcline186">186</a></span><span class="line">            <span class="comment">% motor dynamics</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,187" id="srcline187">187</a></span><span class="line">            [xdot2, xdot2_x, xdot2_u] = model.motor_dynamics_2nd(x(3:end),u(1:2));</span></span>
<span class="srcline"><span class="lineno"><a href="20,188" id="srcline188">188</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,189" id="srcline189">189</a></span><span class="line">            xdot  = [xdot1;</span></span>
<span class="srcline"><span class="lineno"><a href="20,190" id="srcline190">190</a></span><span class="line">                    xdot2];</span></span>
<span class="srcline"><span class="lineno"><a href="20,191" id="srcline191">191</a></span><span class="line">            <span class="comment">% current motor positions</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,192" id="srcline192">192</a></span><span class="line">            <span class="comment">%m     = [x(3);x(4)] ; </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,193" id="srcline193">193</a></span><span class="line">            <span class="keyword">if</span> nargout &gt; 1</span></span>
<span class="srcline"><span class="lineno"><a href="20,194" id="srcline194">194</a></span><span class="line">            <span class="comment">% Compute xdot_x, xdot_u using finite differences</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,195" id="srcline195">195</a></span><span class="line">                <span class="comment">%delta = 1e-6;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,196" id="srcline196">196</a></span><span class="line">                <span class="comment">%dimX = size(x,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,197" id="srcline197">197</a></span><span class="line">                <span class="comment">%dimU = size(u,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,198" id="srcline198">198</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="20,199" id="srcline199">199</a></span><span class="line">            <span class="comment">% Compute derivative of acceleration w.r.t. x</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,200" id="srcline200">200</a></span><span class="line">                 <span class="comment">%daccdx = zeros(1,model.dimX);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,201" id="srcline201">201</a></span><span class="line">                 f = @(x)model.cmptAcc(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,202" id="srcline202">202</a></span><span class="line">                 daccdx = get_jacobian_fd(f,x);</span></span>
<span class="srcline"><span class="lineno"><a href="20,203" id="srcline203">203</a></span><span class="line">                 <span class="keyword">if</span> iscolumn(daccdx), daccdx = daccdx';<span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,204" id="srcline204">204</a></span><span class="line">                 <span class="comment">% Compute derivative of acceleration w.r.t. u</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,205" id="srcline205">205</a></span><span class="line">                 <span class="comment">%daccdu = zeros(1,model.dimU);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,206" id="srcline206">206</a></span><span class="line">                 f = @(u)model.cmptAcc(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,207" id="srcline207">207</a></span><span class="line">                 daccdu = get_jacobian_fd(f,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,208" id="srcline208">208</a></span><span class="line">                 <span class="keyword">if</span> iscolumn(daccdu), daccdu = daccdu'; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,209" id="srcline209">209</a></span><span class="line">                 xdot_x = [0, 1, zeros(1,4);</span></span>
<span class="srcline"><span class="lineno"><a href="20,210" id="srcline210">210</a></span><span class="line">                             daccdx          ;</span></span>
<span class="srcline"><span class="lineno"><a href="20,211" id="srcline211">211</a></span><span class="line">                             zeros(4,2), xdot2_x];</span></span>
<span class="srcline"><span class="lineno"><a href="20,212" id="srcline212">212</a></span><span class="line">           </span></span>
<span class="srcline"><span class="lineno"><a href="20,213" id="srcline213">213</a></span><span class="line">                 xdot_u = [zeros(1,3);</span></span>
<span class="srcline"><span class="lineno"><a href="20,214" id="srcline214">214</a></span><span class="line">                         daccdu; </span></span>
<span class="srcline"><span class="lineno"><a href="20,215" id="srcline215">215</a></span><span class="line">                         xdot2_u,zeros(4,1)];</span></span>
<span class="srcline"><span class="lineno"><a href="20,216" id="srcline216">216</a></span><span class="line">             <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,217" id="srcline217">217</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,218" id="srcline218">218</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,219" id="srcline219">219</a></span><span class="line">        <span class="keyword">function</span> [xdot, xdot_x, xdot_u] = dynamics_with_jacobian(model,x,u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,220" id="srcline220">220</a></span><span class="line">            xdot = model.dynamics(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,221" id="srcline221">221</a></span><span class="line">            <span class="keyword">if</span> nargout &gt; 1</span></span>
<span class="srcline"><span class="lineno"><a href="20,222" id="srcline222">222</a></span><span class="line">                xdot_x = model.dynx(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,223" id="srcline223">223</a></span><span class="line">                xdot_u = model.dynu(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,224" id="srcline224">224</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,225" id="srcline225">225</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,226" id="srcline226">226</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,227" id="srcline227">227</a></span><span class="line">        <span class="keyword">function</span> acc = cmptAcc(model,x,u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,228" id="srcline228">228</a></span><span class="line">           acc = model.torque_total(x,u)./model.inertia;</span></span>
<span class="srcline"><span class="lineno"><a href="20,229" id="srcline229">229</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,230" id="srcline230">230</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,231" id="srcline231">231</a></span><span class="line">        <span class="keyword">function</span> k = stiffness(model, x)           </span></span>
<span class="srcline"><span class="lineno"><a href="20,232" id="srcline232">232</a></span><span class="line">            k =  model.actuator.stiffness(x(1),x(3),x(4));</span></span>
<span class="srcline"><span class="lineno"><a href="20,233" id="srcline233">233</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,234" id="srcline234">234</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,235" id="srcline235">235</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,236" id="srcline236">236</a></span><span class="line">        <span class="comment">%variable damping</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,237" id="srcline237">237</a></span><span class="line">        <span class="keyword">function</span> d = damping(model,~,u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,238" id="srcline238">238</a></span><span class="line">            <span class="comment">% duty_circle: 0-1</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,239" id="srcline239">239</a></span><span class="line">            <span class="comment">% linear on duty-circle</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,240" id="srcline240">240</a></span><span class="line">            d = model.actuator.damping(u(3));</span></span>
<span class="srcline"><span class="lineno"><a href="20,241" id="srcline241">241</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,242" id="srcline242">242</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,243" id="srcline243">243</a></span><span class="line">        <span class="keyword">function</span> torque = torque_spring(model, x,~)</span></span>
<span class="srcline"><span class="lineno"><a href="20,244" id="srcline244">244</a></span><span class="line">            <span class="comment">%sprdis = model.spring_displacement(x,u);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,245" id="srcline245">245</a></span><span class="line">            <span class="comment">%spring_force = sprdis*model.spring_constant;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,246" id="srcline246">246</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,247" id="srcline247">247</a></span><span class="line">            torque = model.actuator.torque_spring(x(1),x(3),x(4));</span></span>
<span class="srcline"><span class="lineno"><a href="20,248" id="srcline248">248</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,249" id="srcline249">249</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,250" id="srcline250">250</a></span><span class="line">        <span class="keyword">function</span> torque_damp = torque_damping(model,x,u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,251" id="srcline251">251</a></span><span class="line">            <span class="comment">% note size(x,2) == size(u,2)</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,252" id="srcline252">252</a></span><span class="line">            torque_damp = model.actuator.torque_damping(x(2),u(3));</span></span>
<span class="srcline"><span class="lineno"><a href="20,253" id="srcline253">253</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,254" id="srcline254">254</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,255" id="srcline255">255</a></span><span class="line">        <span class="keyword">function</span> torque = torque(model, x, u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,256" id="srcline256">256</a></span><span class="line">            torque = model.actuator.torque(x(1),x(2),x(3),x(4),u(3));</span></span>
<span class="srcline"><span class="lineno"><a href="20,257" id="srcline257">257</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,258" id="srcline258">258</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,259" id="srcline259">259</a></span><span class="line">        <span class="keyword">function</span> torque_total = torque_total(model,x,u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,260" id="srcline260">260</a></span><span class="line">            torque_total = model.actuator.torque(x(1),x(2),x(3),x(4),u(3)) - model.Df*x(2);</span></span>
<span class="srcline"><span class="lineno"><a href="20,261" id="srcline261">261</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,262" id="srcline262">262</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,263" id="srcline263">263</a></span><span class="line">        <span class="keyword">function</span> tau_m = tau_m1(model, x, u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,264" id="srcline264">264</a></span><span class="line">            <span class="comment">% tau_m of servo1 at servo's shaft</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,265" id="srcline265">265</a></span><span class="line">            tau_l = model.torque_spring(x)/model.actuator.gear;</span></span>
<span class="srcline"><span class="lineno"><a href="20,266" id="srcline266">266</a></span><span class="line">            p = model.alpha_servo;</span></span>
<span class="srcline"><span class="lineno"><a href="20,267" id="srcline267">267</a></span><span class="line">            accel = p^2*(u(1)-x(3)) - 2*p*x(5);</span></span>
<span class="srcline"><span class="lineno"><a href="20,268" id="srcline268">268</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,269" id="srcline269">269</a></span><span class="line">            tau_m = tau_l + model.D_m1*x(5) + model.inertia_m1*accel;</span></span>
<span class="srcline"><span class="lineno"><a href="20,270" id="srcline270">270</a></span><span class="line">            <span class="comment">%tau_m = tau_l;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,271" id="srcline271">271</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,272" id="srcline272">272</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,273" id="srcline273">273</a></span><span class="line">        <span class="keyword">function</span> tau_m = tau_m2(model, x, u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,274" id="srcline274">274</a></span><span class="line">            <span class="comment">% tau_m of servo2 at servo's shaft</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,275" id="srcline275">275</a></span><span class="line">            tau_l = model.actuator.spring_displacement(x(1),x(3),x(4))*model.actuator.Ks;</span></span>
<span class="srcline"><span class="lineno"><a href="20,276" id="srcline276">276</a></span><span class="line">            p = model.alpha_servo;</span></span>
<span class="srcline"><span class="lineno"><a href="20,277" id="srcline277">277</a></span><span class="line">            accel = p^2*(u(2)-x(4)) - 2*p*x(6);</span></span>
<span class="srcline"><span class="lineno"><a href="20,278" id="srcline278">278</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,279" id="srcline279">279</a></span><span class="line">            tau_m = tau_l + model.D_m2*x(6) + model.inertia_m2*accel;</span></span>
<span class="srcline"><span class="lineno"><a href="20,280" id="srcline280">280</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,281" id="srcline281">281</a></span><span class="line">        <span class="keyword">function</span> [p_total, p1, p2  ] = total_power(model, x, u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,282" id="srcline282">282</a></span><span class="line">            tau_m1 = model.tau_m1(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,283" id="srcline283">283</a></span><span class="line">            tau_m2 = model.tau_m2(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,284" id="srcline284">284</a></span><span class="line">            I1 = tau_m1/model.K_m1;</span></span>
<span class="srcline"><span class="lineno"><a href="20,285" id="srcline285">285</a></span><span class="line">            I2 = tau_m2/model.K_m2;</span></span>
<span class="srcline"><span class="lineno"><a href="20,286" id="srcline286">286</a></span><span class="line">            p1e = I1^2*model.R_m1;</span></span>
<span class="srcline"><span class="lineno"><a href="20,287" id="srcline287">287</a></span><span class="line">            p2e = I2^2*model.R_m2;</span></span>
<span class="srcline"><span class="lineno"><a href="20,288" id="srcline288">288</a></span><span class="line">            p1m = tau_m1*x(5);</span></span>
<span class="srcline"><span class="lineno"><a href="20,289" id="srcline289">289</a></span><span class="line">            p2m = tau_m2*x(6);</span></span>
<span class="srcline"><span class="lineno"><a href="20,290" id="srcline290">290</a></span><span class="line">            <span class="keyword">if</span> p1m &lt; 0, p1m =0; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,291" id="srcline291">291</a></span><span class="line">            <span class="keyword">if</span> p2m &lt; 0, p2m =0; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,292" id="srcline292">292</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,293" id="srcline293">293</a></span><span class="line">            p_total = p1e + p2e + p1m + p2m ;</span></span>
<span class="srcline"><span class="lineno"><a href="20,294" id="srcline294">294</a></span><span class="line">            p1 = p1e + p1m;</span></span>
<span class="srcline"><span class="lineno"><a href="20,295" id="srcline295">295</a></span><span class="line">            p2 = p2e + p2m;</span></span>
<span class="srcline"><span class="lineno"><a href="20,296" id="srcline296">296</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,297" id="srcline297">297</a></span><span class="line">        <span class="keyword">function</span> [p_ntotal, p1, p2  ] = net_total_power(model, x, u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,298" id="srcline298">298</a></span><span class="line">            d = model.damping(u(3));</span></span>
<span class="srcline"><span class="lineno"><a href="20,299" id="srcline299">299</a></span><span class="line">            [p, p1, p2] = model.total_power(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,300" id="srcline300">300</a></span><span class="line">            p_ntotal = p - d*x(2)^2*model.rege_ratio;</span></span>
<span class="srcline"><span class="lineno"><a href="20,301" id="srcline301">301</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,302" id="srcline302">302</a></span><span class="line">        <span class="keyword">function</span> [power, p1, p2] = power_mech(model,x,u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,303" id="srcline303">303</a></span><span class="line">            tau_m1 = model.tau_m1(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,304" id="srcline304">304</a></span><span class="line">            tau_m2 = model.tau_m2(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,305" id="srcline305">305</a></span><span class="line">            p1 = tau_m1*x(5);</span></span>
<span class="srcline"><span class="lineno"><a href="20,306" id="srcline306">306</a></span><span class="line">            p2 = tau_m2*x(6);</span></span>
<span class="srcline"><span class="lineno"><a href="20,307" id="srcline307">307</a></span><span class="line">            power = p1 + p2;</span></span>
<span class="srcline"><span class="lineno"><a href="20,308" id="srcline308">308</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,309" id="srcline309">309</a></span><span class="line">        <span class="keyword">function</span> [power, p1_elec, p2_elec, p1_diss, p2_diss] = power_elec(model, x, u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,310" id="srcline310">310</a></span><span class="line">            tau_m1 = model.tau_m1(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,311" id="srcline311">311</a></span><span class="line">            tau_m2 = model.tau_m2(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,312" id="srcline312">312</a></span><span class="line">            I1 = tau_m1/model.K_m1;</span></span>
<span class="srcline"><span class="lineno"><a href="20,313" id="srcline313">313</a></span><span class="line">            I2 = tau_m2/model.K_m2;</span></span>
<span class="srcline"><span class="lineno"><a href="20,314" id="srcline314">314</a></span><span class="line">            p1_diss = I1^2*model.R_m1;</span></span>
<span class="srcline"><span class="lineno"><a href="20,315" id="srcline315">315</a></span><span class="line">            p2_diss = I2^2*model.R_m2;</span></span>
<span class="srcline"><span class="lineno"><a href="20,316" id="srcline316">316</a></span><span class="line">            p1_mech = tau_m1*x(5);</span></span>
<span class="srcline"><span class="lineno"><a href="20,317" id="srcline317">317</a></span><span class="line">            p2_mech = tau_m2*x(6);</span></span>
<span class="srcline"><span class="lineno"><a href="20,318" id="srcline318">318</a></span><span class="line">            p1_elec = p1_diss + p1_mech;</span></span>
<span class="srcline"><span class="lineno"><a href="20,319" id="srcline319">319</a></span><span class="line">            p2_elec = p2_diss + p2_mech;</span></span>
<span class="srcline"><span class="lineno"><a href="20,320" id="srcline320">320</a></span><span class="line">            power = p1_elec + p2_elec;</span></span>
<span class="srcline"><span class="lineno"><a href="20,321" id="srcline321">321</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,322" id="srcline322">322</a></span><span class="line">        <span class="keyword">function</span> p = power_charge(model, x, u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,323" id="srcline323">323</a></span><span class="line">            p = model.actuator.p_damp_charge(x(2),u(3));</span></span>
<span class="srcline"><span class="lineno"><a href="20,324" id="srcline324">324</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,325" id="srcline325">325</a></span><span class="line">        <span class="keyword">function</span> power = net_mechpower(model,x,u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,326" id="srcline326">326</a></span><span class="line">            <span class="comment">% net output mechanical power on motor level</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,327" id="srcline327">327</a></span><span class="line">            <span class="comment">% note that motor's power has to be non-negative because energy</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,328" id="srcline328">328</a></span><span class="line">            <span class="comment">% is not recoverable on motor level</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,329" id="srcline329">329</a></span><span class="line">            <span class="comment">% Note: don't support vector computation currently</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,330" id="srcline330">330</a></span><span class="line">            power_outmech = model.output_mechpower(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,331" id="srcline331">331</a></span><span class="line">            d = model.actuator.damping(u(3));</span></span>
<span class="srcline"><span class="lineno"><a href="20,332" id="srcline332">332</a></span><span class="line">            <span class="comment">%power_motor1 = sigmf(power_motor1, [10000 0]);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,333" id="srcline333">333</a></span><span class="line">            <span class="comment">%power_motor2 = sigmf(power_motor2, [10000 0]);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,334" id="srcline334">334</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,335" id="srcline335">335</a></span><span class="line">            power = power_outmech - d*x(2)^2*model.rege_ratio;</span></span>
<span class="srcline"><span class="lineno"><a href="20,336" id="srcline336">336</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,337" id="srcline337">337</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,338" id="srcline338">338</a></span><span class="line">        <span class="keyword">function</span> [power, power_motor1, power_motor2] = output_mechpower(model,x,u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,339" id="srcline339">339</a></span><span class="line">            <span class="comment">% output mechanical power on motor level</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,340" id="srcline340">340</a></span><span class="line">            <span class="comment">% note that motor's power has to be non-negative because energy</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,341" id="srcline341">341</a></span><span class="line">            <span class="comment">% is not recoverable on motor level</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,342" id="srcline342">342</a></span><span class="line">            <span class="comment">% Note: don't support vector computation currently</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,343" id="srcline343">343</a></span><span class="line">            kappa = model.actuator.Ks;</span></span>
<span class="srcline"><span class="lineno"><a href="20,344" id="srcline344">344</a></span><span class="line">            B = model.actuator.B;</span></span>
<span class="srcline"><span class="lineno"><a href="20,345" id="srcline345">345</a></span><span class="line">            C = model.actuator.C;</span></span>
<span class="srcline"><span class="lineno"><a href="20,346" id="srcline346">346</a></span><span class="line">            r = model.actuator.r;</span></span>
<span class="srcline"><span class="lineno"><a href="20,347" id="srcline347">347</a></span><span class="line">            gear = model.actuator.gear;</span></span>
<span class="srcline"><span class="lineno"><a href="20,348" id="srcline348">348</a></span><span class="line">            A0 = model.actuator.A0;</span></span>
<span class="srcline"><span class="lineno"><a href="20,349" id="srcline349">349</a></span><span class="line">            A = sqrt(B^2+C^2 - 2*B*C*cos(x(3)/gear-x(1)));</span></span>
<span class="srcline"><span class="lineno"><a href="20,350" id="srcline350">350</a></span><span class="line">            L = A + r*x(4) - A0; </span></span>
<span class="srcline"><span class="lineno"><a href="20,351" id="srcline351">351</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,352" id="srcline352">352</a></span><span class="line">            tau_s = model.torque_spring(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,353" id="srcline353">353</a></span><span class="line">            tau_l1 = tau_s/gear;</span></span>
<span class="srcline"><span class="lineno"><a href="20,354" id="srcline354">354</a></span><span class="line">            tau_l2 = kappa*L*r;</span></span>
<span class="srcline"><span class="lineno"><a href="20,355" id="srcline355">355</a></span><span class="line">            power_motor1 = tau_l1*x(5);</span></span>
<span class="srcline"><span class="lineno"><a href="20,356" id="srcline356">356</a></span><span class="line">            power_motor2 = tau_l2*x(6);</span></span>
<span class="srcline"><span class="lineno"><a href="20,357" id="srcline357">357</a></span><span class="line">            <span class="comment">%if (power_motor1 &lt;= 0)</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,358" id="srcline358">358</a></span><span class="line">            <span class="comment">%    power_motor1 = 0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,359" id="srcline359">359</a></span><span class="line">            <span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,360" id="srcline360">360</a></span><span class="line">            <span class="comment">%if (power_motor2 &lt;= 0)</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,361" id="srcline361">361</a></span><span class="line">            <span class="comment">%    power_motor2 = 0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,362" id="srcline362">362</a></span><span class="line">            <span class="comment">%end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,363" id="srcline363">363</a></span><span class="line">            <span class="comment">%power_motor1 = sigmf(power_motor1, [10000 0]);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,364" id="srcline364">364</a></span><span class="line">            <span class="comment">%power_motor2 = sigmf(power_motor2, [10000 0]);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,365" id="srcline365">365</a></span><span class="line">            power = power_motor1 + power_motor2;</span></span>
<span class="srcline"><span class="lineno"><a href="20,366" id="srcline366">366</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,367" id="srcline367">367</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,368" id="srcline368">368</a></span><span class="line">        <span class="keyword">function</span> [ xdot, xdot_x, xdot_u ] = motor_dynamics_2nd(model, x, u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,369" id="srcline369">369</a></span><span class="line">            p = model.alpha_servo;</span></span>
<span class="srcline"><span class="lineno"><a href="20,370" id="srcline370">370</a></span><span class="line">            A = [ 0, 0, 1, 0;</span></span>
<span class="srcline"><span class="lineno"><a href="20,371" id="srcline371">371</a></span><span class="line">                0, 0, 0, 1;</span></span>
<span class="srcline"><span class="lineno"><a href="20,372" id="srcline372">372</a></span><span class="line">                -p^2, 0, -2*p, 0;</span></span>
<span class="srcline"><span class="lineno"><a href="20,373" id="srcline373">373</a></span><span class="line">                0, -p^2, 0, -2*p];</span></span>
<span class="srcline"><span class="lineno"><a href="20,374" id="srcline374">374</a></span><span class="line">            B = [ 0, 0;</span></span>
<span class="srcline"><span class="lineno"><a href="20,375" id="srcline375">375</a></span><span class="line">                0, 0;</span></span>
<span class="srcline"><span class="lineno"><a href="20,376" id="srcline376">376</a></span><span class="line">                p^2, 0;</span></span>
<span class="srcline"><span class="lineno"><a href="20,377" id="srcline377">377</a></span><span class="line">                0, p^2];</span></span>
<span class="srcline"><span class="lineno"><a href="20,378" id="srcline378">378</a></span><span class="line">            xdot = A*x + B*u;</span></span>
<span class="srcline"><span class="lineno"><a href="20,379" id="srcline379">379</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,380" id="srcline380">380</a></span><span class="line">            <span class="keyword">if</span> nargout &gt; 1</span></span>
<span class="srcline"><span class="lineno"><a href="20,381" id="srcline381">381</a></span><span class="line">                xdot_x  = A;  </span></span>
<span class="srcline"><span class="lineno"><a href="20,382" id="srcline382">382</a></span><span class="line">                xdot_u  = B; </span></span>
<span class="srcline"><span class="lineno"><a href="20,383" id="srcline383">383</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,384" id="srcline384">384</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,385" id="srcline385">385</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,386" id="srcline386">386</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,387" id="srcline387">387</a></span><span class="line">        <span class="keyword">function</span> dr = damping_ratio(model, x, u)</span></span>
<span class="srcline"><span class="lineno"><a href="20,388" id="srcline388">388</a></span><span class="line">            b = model.Df + model.damping(x,u);</span></span>
<span class="srcline"><span class="lineno"><a href="20,389" id="srcline389">389</a></span><span class="line">            k = model.stiffness(x);</span></span>
<span class="srcline"><span class="lineno"><a href="20,390" id="srcline390">390</a></span><span class="line">            dr = b/2*sqrt(k*model.inertia);</span></span>
<span class="srcline"><span class="lineno"><a href="20,391" id="srcline391">391</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,392" id="srcline392">392</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,393" id="srcline393">393</a></span><span class="line">    <span class="keyword">end</span>     </span></span>
<span class="srcline"><span class="lineno"><a href="20,394" id="srcline394">394</a></span><span class="line">        <span class="keyword">methods</span> (Static)</span></span>
<span class="srcline"><span class="lineno"><a href="20,395" id="srcline395">395</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,396" id="srcline396">396</a></span><span class="line"><span class="comment">%             function [xdot, xdot_x, xdot_u] = motor_dynamics_3rd(x,u, p)</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,397" id="srcline397">397</a></span><span class="line"><span class="comment">%                 z     = zeros(3,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,398" id="srcline398">398</a></span><span class="line"><span class="comment">%                 Z     = zeros(3,3);</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,399" id="srcline399">399</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,400" id="srcline400">400</a></span><span class="line"><span class="comment">%                 Af1 = [0,     1,     0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,401" id="srcline401">401</a></span><span class="line"><span class="comment">%                     0,     0,     1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,402" id="srcline402">402</a></span><span class="line"><span class="comment">%                     -p(1), -p(2), -p(3)];</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,403" id="srcline403">403</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,404" id="srcline404">404</a></span><span class="line"><span class="comment">%                 Bf1 = [0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,405" id="srcline405">405</a></span><span class="line"><span class="comment">%                     0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,406" id="srcline406">406</a></span><span class="line"><span class="comment">%                     p(1)];</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,407" id="srcline407">407</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,408" id="srcline408">408</a></span><span class="line"><span class="comment">%                 Af2 = [0,     1,     0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,409" id="srcline409">409</a></span><span class="line"><span class="comment">%                     0,     0,     1;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,410" id="srcline410">410</a></span><span class="line"><span class="comment">%                     -p(4), -p(5), -p(6)];</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,411" id="srcline411">411</a></span><span class="line"><span class="comment">%   </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,412" id="srcline412">412</a></span><span class="line"><span class="comment">%                 Bf2 = [0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,413" id="srcline413">413</a></span><span class="line"><span class="comment">%                    0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,414" id="srcline414">414</a></span><span class="line"><span class="comment">%                    p(4)];</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,415" id="srcline415">415</a></span><span class="line"><span class="comment">%  </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,416" id="srcline416">416</a></span><span class="line"><span class="comment">%                 A = [Af1,Z;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,417" id="srcline417">417</a></span><span class="line"><span class="comment">%                 Z ,Af2];</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,418" id="srcline418">418</a></span><span class="line"><span class="comment">%  </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,419" id="srcline419">419</a></span><span class="line"><span class="comment">%                 B = [Bf1, z;</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,420" id="srcline420">420</a></span><span class="line"><span class="comment">%                 z ,Bf2];</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,421" id="srcline421">421</a></span><span class="line"><span class="comment">%     </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,422" id="srcline422">422</a></span><span class="line"><span class="comment">%                 xdot    = A * x + B * u;  </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,423" id="srcline423">423</a></span><span class="line"><span class="comment">%                 if nargout &gt; 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,424" id="srcline424">424</a></span><span class="line"><span class="comment">%                 xdot_x  = A;  </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,425" id="srcline425">425</a></span><span class="line"><span class="comment">%                 xdot_u  = B; </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,426" id="srcline426">426</a></span><span class="line"><span class="comment">%                 end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,427" id="srcline427">427</a></span><span class="line"><span class="comment">%             end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,428" id="srcline428">428</a></span><span class="line"><span class="comment">%             </span></span></span>
<span class="srcline"><span class="lineno"><a href="20,429" id="srcline429">429</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,430" id="srcline430">430</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,431" id="srcline431">431</a></span><span class="line">            </span></span>
<span class="srcline"><span class="lineno"><a href="20,432" id="srcline432">432</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,433" id="srcline433">433</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="20,434" id="srcline434">434</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="20,435" id="srcline435">435</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="20,436" id="srcline436">436</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="20,437" id="srcline437">437</a></span><span class="line"> </span></span>
</pre>
</div>
</body>
</html>
